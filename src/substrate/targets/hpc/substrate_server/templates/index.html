<!doctype html>
    <head>
        <title>Substrate HPC</title>
        <style>
            :root {
                --gradient_1: linear-gradient(rgb(157, 255, 118), rgb(48, 255, 21));
            }

            * {
                box-sizing: border-box;
                -moz-box-sizing: border-box;
                -webkit-box-sizing: border-box;
                margin: 0px;
                padding: 0px;
            }
            html, body {
                height: 100%;
                width: 100%;
            }
            iframe, #application {
                display: block;
                width: 100%;
                height: 100%;
                border: none;
                padding: 0px;
                margin: 0px;
            }

            #startup {
                position: fixed;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
            }
            #new_allocation, #new_allocation:after {
                position: relative;
                background: var(--gradient_1);
                width: 200px;
                height: 75px;
                border-radius: 25px;
                border: none;
                font-size: 1.5em;
                color: white;
                box-shadow: 5px 5px 7px rgba(0, 0, 0, 0.5);
                transition: all 0.5s;
                -webkit-transition: all 0.5s;
                -moz-transition: all 0.5s;
            }
            #new_allocation:active, #new_allocation:active:after {
                width: 190px;
                height: 65px;
                border-radius: 20px;
                transition: all 0.0s;
                -webkit-transition: all 0.0s;
                -moz-transition: all 0.0s;
                box-shadow: none;
                top: 5px;
                left: 5px;
            }
            #new_allocation:after {
                position: absolute;
                top: 0;
                left: 0;
                content: '\A';
                width: 100%;
                height: 100%;
                margin: 0;
                padding: 0;
                background:rgba(0,0,0,0.2);
                opacity: 0;
            }
            #new_allocation:hover:after {
                opacity: 1;
            }
            #new_allocation:active:after {
                top: 0px;
                left: 0px;
                opacity: 0;
            }

            #overlay {
                position: absolute;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                pointer-events: none;
            }

            #sidebar {
                position: relative;
                float: right;
                display: flex;
                flex-flow: column;
                width: 300px;
                height: 100%;
            }

            #login_terminal, #cluster_terminal {
                flex: 1;
                display: none;
            }
            
            #status {
                width: 100%;
                height: 75px;
                background: rgba(0,0,0,0.25);
                pointer-events: all;
            }
            #status_page {
                height: 25%;
                width: 100%;
                text-align: center;
                display: flex;
                flex-flow: row nowrap;
                justify-content: space-between;
                align-items: center;
            }
            #pages {
                width: 50px;
                display: flex;
                flex-flow: row nowrap;
                justify-content: space-between;
            }
            #pages * {
                width: 10px;
                margin: 0 auto;
            }
            #status_header {
                height: 25%;
                width: 100%;
                border: 1px solid black;
                border-bottom: none;
                text-align: center;
            }
            #status_header > *:before {
                content:"";
                display: inline-block;
                height: 100%;
                vertical-align: middle;
            }
            #status_header > * {
                text-align: center;
                height: 100%;
            }
            #change_status_left, #change_status_right {
                width: 20px;
                cursor: pointer;
            }
            #change_status_left {
                border-right: 1px solid black;
            }
            #change_status_right{
                border-left: 1px solid black;
            }
            #change_status_left:hover, #change_status_right:hover {
                background: rgba(0,0,0,0.1);
            }
            .status-type {
                height: 50%;
            }

            .info:before {
                content:"";
                display: inline-block;
                height: 100%;
                vertical-align: middle;
            }
            .info {
                height: 50%;
                width: 100%;
                text-align: center;
                border: 1px solid black;
                border-bottom: none;
            } 

            
            .options {
                width: 100%;
                height: 50%;
                margin: 0 auto;
                display: flex;
                flex-flow: row nowrap;
                justify-content: space-between;
            }
            
            /*for line-height 100%*/
            .options div:before{
                content:"";
                display: inline-block;
                height: 100%;
                vertical-align: middle;
            }
            .options div {
                width: 50%;
                margin: 0 auto;
                text-align: center;
                border: 1px solid black;
                cursor: pointer;
            }
            .options div:hover {
                background: rgba(0,0,0,0.1);
            }




            #allocation_options_modal {
                display: grid;
            }
            #allocation_options_modal {
                padding: 20px;
                width: 600px;
                height: 400px;
                background-color: grey;
                border-radius: 25px;
            }
            #allocation_options_modal form{
                width: 100%;
                height: 100%;
                display: grid;
                grid-template-columns: 1fr 1fr;
                grid-template-rows: auto;
            }
            #allocation_options_modal form hr{
                border: none;
                height: 40px;
            }

            .loader {
                position: absolute;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                border: 16px solid #f3f3f3;
                border-radius: 50%;
                border-top: 16px solid #3498db;
                width: 120px;
                height: 120px;
                -webkit-animation: spin 2s linear infinite; /* Safari */
                animation: spin 2s linear infinite;
            }

            /* Safari */
            @-webkit-keyframes spin {
                0% { -webkit-transform: rotate(0deg); }
                100% { -webkit-transform: rotate(360deg); }
            }

            @keyframes spin {
                0% { transform: rotate(0deg); }
                100% { transform: rotate(360deg); }
            }

            
        </style>
        <link rel="shortcut icon" href="data:image/x-icon;," type="image/x-icon"> 
    </head>

    <body style="display: none">
        <div id="startup">
            <button id="new_allocation" onclick="new_cluster_options()">
                New Cluster
            </button>
            <div id="allocation_options_modal">
                <form onsubmit="return new_allocation(event)">
                    <label for="account">Account: </label>
                    <input type="text" id="account" name="account" placeholder="abc123">

                    <label for="GPU">GPU: </label>
                    <input type="checkbox" id="GPU" name="GPU">

                    <label for="time">Time: </label>
                    <input type="time" id="time" name="time">

                    <label for="nodes">Nodes: </label>
                    <input type="number" id="nodes" name="nodes">

                    <hr><hr>

                    <label for="local_port">Local Port: </label>
                    <input type="number" id="local_port" name="local_port" value="5000">

                    <label for="remote_port">Remote Port: </label>
                    <input type="number" id="remote_port" name="remote_port" value="8030">

                    <label for="remote_host">Remote Host: </label>
                    <input type="text" id="remote_port" name="remote_port" value="127.0.0.1">

                    <label for="remote_command">Remote Command: </label>
                    <input type="text" id="remote_command" name="remote_command" value="./app.sh">
                    
                    <hr>
                    <input type="submit" name="submit" value="OK">

                </form>
            </div>


        </div>
        <div id="overlay">
            <div class="loader" id="loader"></div>

            <div id="sidebar">
                <div id="status">
                    <div id="status_page">
                        <div id="change_status_left" onclick="cycle_status_left()"><</div>
                        <div id="pages">
                            <div class=".var_login_node_status">o</div>
                            <div class=".var_cluster_status">o</div>
                            <div class=".var_running_status">o</div>
                        </div>
                        <div id="change_status_right" onclick="cycle_status_right()">></div>
                    </div>
                    <div id="status_header">
                        <span id="status_name"></span>
                    </div>
                    
                    <div class="status-type" id="login_node_status">
                        <div class="info">
                            <span>Status</span>: <span class="var">Disconnected</span>
                        </div>
                        <div class="options">
                            <div onclick="cancel_cluster()">Cancel</div>
                            <div onclick="toggle_terminal('login')">Details</div>
                        </div>
                    </div>

                    <div class="status-type" id="cluster_status">
                        <div class="info">
                            <span>Status</span>: <span class="var">Disconnected</span>
                        </div>
                        <div class="options">
                            <div onclick="cancel_cluster()">Cancel</div>
                            <div onclick="toggle_terminal('cluster')">Details</div>
                        </div>
                    </div>

                    <div class="status-type" id="running_status">
                        <div class="info">
                            <span>Status</span>: <span class="var">Disconnected</span>
                        </div>
                        <div class="options">
                            <div onclick="cancel_cluster()">Cancel</div>
                            <div onclick="scale()" id="scale">Scale</div>
                            <div onclick="restart()" id="restart">Restart</div>
                            <div onclick="kill()" id="kill">Shutdown</div>
                        </div>
                    </div>
                </div>
                
                
                <div id="login_terminal">
                    <iframe src="http://127.0.0.1:5001/terminal"></iframe>
                </div>
                <div id="cluster_terminal">
                    <iframe src="http://127.0.0.1:5002/terminal"></iframe>
                </div>
            
            </div>
        </div>
        <div id="application">
            <!--<iframe id="application_iframe" src="./cluster_down"></iframe>-->
        </div>
    </body>
    
    <!-- socketio -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js" integrity="sha512-q/dWJ3kcmjBLU4Qc47E4A9kTB4m3wuTY7vkFJDTZKjTs8jhyGQnaUrxa0Ytd0ssMZhbNua9hE+E7Qv1j+DyZwA==" crossorigin="anonymous"></script>
    
    <!-- user script -->
    <script type="text/javascript" charset="utf-8">

    /*
        TODO:
        2. shutdown button
        3. new cluster button
        4. restart server on cluster button
        5. scale cluster button
        6. style CSS better - debug/cluster_down page
        7. integrate into substrate
    */

    function post(url, data){
        return fetch(url, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(data),
        });
    }
    function get(url){
        return fetch(url);
    }

    function shutdown(){
        console.log('TODO');
        return;

        get('/shutdown');
    }

    function restart(){
        console.log('TODO');
        return;

        get('/restart');

    }

    function scale(){
        console.log('TODO');
        return;

        const data = {
            nodes: 1,
        }
        post('/scale', data);
    }
    
    function new_cluster(){
        document.getElementById('new_allocation').style.display = 'block';
        document.getElementById('allocation_options_modal').style.display = 'none';
        document.getElementById('startup').style.display = 'block';
        document.getElementById('loader').style.display = 'none';
    }
    function new_cluster_options(){
        const button = document.getElementById('new_allocation');
        button.style.display = 'none';
        const modal = document.getElementById('allocation_options_modal');
        modal.style.display = 'block';
    }
    
    function validate(formData){
        let ret = true;
        const errs = Object.fromEntries(Object.entries(formData).map(([key, value]) => {
            let err = null;
            switch(key){
                case 'account': 
                    if(value.length <= 0) err = 'length'
                    break;
                case 'time':
                    if(!/^\d+:[0-9][0-9]$/.test(key)) err = 'incorrect time format'
                    break;
                case 'nodes': 
                    if(!(0 < parseInt(value) && parseInt(value) <= 32)) err = 'incorrect format';
                    break;
                case 'local_port':
                case 'remote_port':
                    if(0 < parseInt(value)) err = 'incorrect format'; 
                    break;
                default:
                    err = null;
            }
            if(err != null) ret = false;
            return [key, err];
        }));
        return [ret, errs]
    }
    function new_allocation(e){
        let formData = null;
        if(e instanceof Event){
            e.preventDefault();
            formData = Object.fromEntries(Array.from(e.target.elements).map(el => [el.name, el.value]));
        } else {
            formData = e;
        }

        if(formData){
            let [valid, errs] = validate(formData);
            //delete me
            valid = true;
            if(!valid) {
                console.log(errs)
                return false;
            }
            
            fetch('/new_cluster', formData);
        }

        const modal = document.getElementById('allocation_options_modal');
        const startup = document.getElementById('startup');
        startup.style.display = modal.style.display = 'none';
        
        set_status_avail('running_status', true);
        set_status_avail('login_node_status', true);
        set_status_avail('cluster_status', true);
        const status_el = set_status_mode('login_node_status');
        const span = status_el.querySelector('.var');
        span.innerHTML = 'Connecting...'
        document.getElementById('loader').style.display = 'block';
    
        return false;
    }

    
    const socket_login =   io('127.0.0.1:5001/');
    const socket_cluster = io('127.0.0.1:5002/');

    function query_get(query){
        const url = new URL(`${window.location}command`);
        for(const [key, value] of Object.entries(query)){
            url.searchParams.set(key, value);
        }
        return fetch(url.href)
    }

    function kill_server(){
        return query_get({'command': 'kill'})
        .then(res => res.json()).then(data => {
            console.log(data);
        });
    }

    function salloc(){
        return query_get({'command': 'spawn'})
        .then(res => res.json()).then(data => {
            console.log(data);
        });
    }

    function init_app(port){
        const iframe = document.getElementById('application_iframe')
        iframe.src = `127.0.0.1:${port}`
    }

    function destroy_app(){
        const iframe = document.getElementById('application_iframe');
        iframe.src = 'cluster_down.html'
    }

    function cycle_status_left(){
        const prev = get_prev_status();
        if(prev){
            set_status_mode(prev);
        }
    }
    function cycle_status_right(){
        const next = get_next_status();
        if(next){
            set_status_mode(next);
        }
    }

    function changeStatusText(status, text){
        const status_el = document.getElementById('status')
        const span = status_el.querySelector('.var');
        span.innerHTML = text;
    }

    function cancel_cluster(){
        changeStatusText('running_status', 'Disconnected');
        changeStatusText('cluster_status', 'Disconnected');
        changeStatusText('login_node_status', 'Disconnected');
        set_status_mode(null);

        new_cluster();
        console.log('TODO');
    }

    function toggle_terminal(terminal){
        const map = {
            'login': toggle_login_terminal,
            'cluster': toggle_cluster_terminal,
        };
        map[terminal]();
    }

    
    function toggle_cluster_terminal(){
        const mode = get_status_mode().id;
        if(mode != 'cluster_status' && mode != 'running_status') return;
        const terminal = document.getElementById('cluster_terminal');
        const visible = terminal.style.display == 'block';
        terminal.style.display = visible ? 'none' : 'block';
    }

    function toggle_login_terminal(){
        const mode = get_status_mode().id;
        if(mode != 'login_node_status') return;
        const terminal = document.getElementById('login_terminal');
        const visible = terminal.style.display == 'block';
        terminal.style.display = visible ? 'none' : 'block';
    }

    function _set_status_mode(setmode){
        const terminal_status_modes = ['login_node_status', 'cluster_status'];
        
        const terminal_visible = terminal_status_modes.includes(setmode) && (
            document.getElementById('login_terminal').style.display == 'block' || 
            document.getElementById('cluster_terminal').style.display == 'block'
        );
        const modes = get_status_modes();
        
        const terminals = ['login_terminal', 'cluster_terminal'];
        const modeTerminalMap = {
            [modes[0]]: [terminals[0]],
            [modes[1]]: [terminals[1]],
            [modes[2]]: [terminals[1]],
        }

        for(const mode of modes){
            const el = document.getElementById(mode);
            el.style.display = 'none';
            document.getElementsByClassName(`.var_${mode}`)[0].style.color = 'black'
        }
        
        for(const terminal of terminals){
            const el = document.getElementById(terminal);
            el.style.display = 'none';
        }

        if(setmode == null) {
            document.getElementById('status_name').innerHTML = '';
            document.getElementById('status').style.display = 'none';
            new_cluster();
            return;
        }
        document.getElementById('status').style.display = 'block';

        const el = document.getElementById(setmode);
        el.style.display = 'block';

        if(terminal_visible){
            for(terminal of modeTerminalMap[setmode]){
                const el = document.getElementById(terminal);
                el.style.display = 'block';
            }
        }

        document.getElementsByClassName(`.var_${setmode}`)[0].style.color = 'green'
        document.getElementById('status_name').innerHTML = setmode;
        return el;
    }


    const [set_status_avail, set_status_mode, get_status_modes, get_status_mode, get_next_status, get_prev_status] = (()=>{
        const statusOrder = ['login_node_status', 'cluster_status', 'running_status'];
        const statusAvail = {
            'login_node_status': false,
            'cluster_status': false,
            'running_status': false
        };

        statusOrder.forEach(v => document.getElementsByClassName(`.var_${v}`)[0].style.display = 'none');

        const get_status_modes = () => statusOrder;
        let status_mode = null;
        
        const set_status_avail = (mode, avail) => {
            statusAvail[mode] = avail;
            document.getElementsByClassName(`.var_${mode}`)[0].style.display = avail ? 'block' : 'none';
        }

        const set_status_mode = (mode) => {
            if(statusAvail[mode] || mode === null){ 
                return status_mode = _set_status_mode(mode);
            }
            return null;
        }
        const get_status_mode = () => status_mode;

        const get_next_status = () => {
            const curr = statusOrder.indexOf(status_mode.id);
            for(let i = curr+1; i < curr+statusOrder.length; ++i){
                const next = statusOrder[i%statusOrder.length];
                if(statusAvail[next])   return next;
            }
            return null
        };
        const get_prev_status = () => {
            const curr = statusOrder.indexOf(status_mode.id);
            for(let i = curr-1; i > curr-statusOrder.length; --i){
                const prev = statusOrder.at(i);
                if(statusAvail[prev])   return prev;
            }
            return null
        };
        return [set_status_avail, set_status_mode, get_status_modes, get_status_mode, get_next_status, get_prev_status];
    })();




    const config = {};
    (function main(){
        if(config === null){
            set_status_mode(null);
        } else {
            new_allocation(null);
            set_status_mode('login_node_status');
        }

        socket_login.on('connect', () => {
            const status_el = set_status_mode('login_node_status');
            const span = status_el.querySelector('.var');
            span.innerHTML = 'Connected'
        });  
        socket_login.on('disconnect', () => {
            const status_el = set_status_mode('login_node_status');
            const span = status_el.querySelector('.var');
            span.innerHTML = 'Disconnected';
        });
        socket_cluster.on('connect', () => {
            const status_el = set_status_mode('cluster_status');
            const span = status_el.querySelector('.var');
            span.innerHTML = 'Disconnected';
            document.getElementById('loader').style.display = 'none';
        });
        socket_cluster.on('disconnect', () => {
            const status_el = set_status_mode('cluster_status');
            const span = status_el.querySelector('.var');
            span.innerHTML = 'Disconnected';
            document.getElementById('loader').style.display = 'block';
        });
        
        /* 

        //cluster status
        socket_login.on('cluster_estimate', (data) => {});
        //cluster events
        socket_login.on('cluster_connected', (data) => {});
        socket_login.on('cluster_disconnected', (data) => {});
        */
        document.getElementsByTagName('body')[0].style.display = 'block';
    })();

    </script>
</html>
